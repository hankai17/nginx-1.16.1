SecRuleEngine On
SecRequestBodyAccess On

SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

SecRequestBodyJsonDepthLimit 512
SecArgumentsLimit 1000

SecPcreMatchLimit 1000
SecPcreMatchLimitRecursion 1000

SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

SecTmpDir /tmp/
SecDataDir /tmp/

SecDebugLog /opt/modsecurity/var/log/debug.log
SecDebugLogLevel 7

SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log
#SecAuditLogStorageDir /opt/modsecurity/var/audit/

SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine On

SecAuditLogFormat JSON

SecRule ARGS:testparam "@contains test" "id:1234,deny,log,status:403"
#SecRule RESPONSE_BODY "@rx abcdefghijkldef" "phase:4,id:1235,deny,log"

SecRule RESPONSE_BODY "@pmf 1.log" \
	"msg:'PHP Information Leakage',\
	id:953100,\
	phase:4,\
	ver:'OWASP_CRS/3.0.0',\
	rev:'3',\
	maturity:'9',\
	accuracy:'9',\
	t:none,\
	capture,\
	ctl:auditLogParts=+E,\
	deny,\
	severity:'ERROR',\
	logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
        tag:'application-multi',\
        tag:'language-php',\
        tag:'platform-multi',\
        tag:'attack-disclosure',\
	tag:'OWASP_CRS/LEAKAGE/ERRORS_PHP',\
	tag:'WASCTC/WASC-13',\
	tag:'OWASP/A6',\
	tag:'PCI/6.5.6',\
	setvar:'tx.msg=%{rule.msg}',\
	setvar:tx.outbound_anomaly_score=+%{tx.error_anomaly_score},\
	setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.%{rule.id}-OWASP_CRS/LEAKAGE/ERRORS-%{matched_var_name}=%{tx.0}"
###############################################################################################

SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|!REQUEST_HEADERS:Referer|XML:/* "@rx (?i)(?:\x5c|(?:%(?:c(?:0%(?:[2aq]f|5c|9v)|1%(?:[19p]c|8s|af))|2(?:5(?:c(?:0%25af|1%259c)|2f|5c)|%46|f)|(?:(?:f(?:8%8)?0%8|e)0%80%a|bg%q)f|%3(?:2(?:%(?:%6|4)6|F)|5%%63)|u(?:221[56]|002f|EFC8|F025)|1u|5c)|0x(?:2f|5c)|\/))(?:%(?:(?:f(?:(?:c%80|8)%8)?0%8|e)0%80%ae|2(?:(?:5(?:c0%25a|2))?e|%45)|u(?:(?:002|ff0)e|2024)|%32(?:%(?:%6|4)5|E)|c0(?:%[256aef]e|\.))|\.(?:%0[01]|\?)?|\?\.?|0x2e){2}(?:\x5c|(?:%(?:c(?:0%(?:[2aq]f|5c|9v)|1%(?:[19p]c|8s|af))|2(?:5(?:c(?:0%25af|1%259c)|2f|5c)|%46|f)|(?:(?:f(?:8%8)?0%8|e)0%80%a|bg%q)f|%3(?:2(?:%(?:%6|4)6|F)|5%%63)|u(?:221[56]|002f|EFC8|F025)|1u|5c)|0x(?:2f|5c)|\/))" \
    "id:930100,\
    phase:2,\
    block,\
    capture,\
    t:none,\
    msg:'Path Traversal Attack (/../)',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-lfi',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    tag:'OWASP_CRS/WEB_ATTACK/DIR_TRAVERSAL',\
    ver:'OWASP_CRS/3.2.0',\
    severity:'CRITICAL',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
    setvar:'tx.lfi_score=+%{tx.critical_anomaly_score}'"
###############################################################################################

#http://www.wooyun.org/bugs/wooyun-2014-085732
#name=ShopEx Remote File Delete
#cn_name=ShopEx 远程文件删除漏洞
#type=其他
#osvdb=
#cve=
#cwe=CWE-306
#bid=
#msb=
#cnvd=
#cnnvd=
#description=ShopEx contains a flaw that may allow a remote attacker to execute arbitrary commands or code. The issue is due to the shopadmin/index.php script not properly sanitizing user input, specifically directory traversal style attacks (e.g., ../../ Angle brackets) supplied to the &#39;filename&#39; parameter. This may allow an attacker to include a file from the targeted host that contains arbitrary commands or code that will be executed by the vulnerable script.
#cn_description=ShopEx中的shopadmin/index.php中存在远程文件删除漏洞。只判断filename参数前面是否在目录下，没包括过滤 ../、尖括号等符号。
#solution=The filename parameter value filter, ban /..\ appear parameters, or the application of the update to the latest official version.
#cn_solution=对filename参数值进行过滤，禁止参数中出现../ ..\ 尖括号，或将应用更新到官方最新版。
SecRule REQUEST_FILENAME "@rx (?i:(shopadmin/index\.php))" \
    "chain,\
    rev:'WAF/0.0.0',\
    t:none,t:urlDecodeUni,\
    capture,\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    msg:'ShopEx Remote File Delete',\
    tag:'CRS/WEB_ATTACK/Other',\
    phase:2,\
    block,\
    severity:2,\
    id:2100001"

SecRule "ARGS:filename" "@rx \.{1,};{0,}[/\\\\]+\.{1,};{0,}[/\\\\]+" 
    "setvar:'tx.msg=ShopEx shopadmin/index.php Remote File Delete',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"
###############################################################################################

#name=HTTP Request Smuggling
#cn_name=HTTP请求走私
#type=其他
#cve=
#cwe=CWE-444
#bid=
#msb=
#cnvd=
#cnnvd=
#description=The HTTP Request Smuggling attack explores an incomplete parsing of the submitted data done by an intermediary HTTP system working as a proxy.This attack makes it possible to exploit other attacks, like Cache Poisoning, Session Hijacking, Cross-site Scripting (XSS) and most importantly, the ability to bypass web application firewall protection.
#cn_description=这种攻击利用服务器解析的问题,发送攻击数据到服务器,这种攻击可利用其他攻击,如缓存中毒，会话劫持，跨站点脚本(XSS).参考:https://www.owasp.org/index.php/HTTP_Request_Smuggling。
#solution=1. Focus on updating the official home page to the latest version or patching; 2. Deploy the security protection equipment of Ksyun;
#cn_solution=1、关注官方主页更新至最新版本或打补丁；2、部署金山云安全防护设备；
SecRule REQUEST_HEADERS:Content-Length|REQUEST_HEADERS:Transfer-Encoding "@rx ssss" \
    "rev:'1',\
    id:1010005, \
    ver:'WAF_CRS/0.0.0',\
    t:none,capture,\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    msg:'HTTP Request Smuggling Attack.',\
    tag:'WAF_CRS/WEB_ATTACK/REQUEST_SMUGGLING',\
    setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},\
    tag:'OWASP/A1',\
    phase:1,\
    block,\
    severity:4,\
    accuracy:6,\
    id:1010005, \
    maturity:6"

